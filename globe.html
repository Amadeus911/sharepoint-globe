<!-- load D3 and TopoJSON BEFORE your code -->
<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>

<style>
  #globeContainer {
    width: 400px; height: 400px;
    margin: auto;
    position: relative;
  }
  .sphere { fill: #1f4e79; }
  .land   { fill: #2a6eb8; stroke: #000; stroke-width: .3px; }
  .marker    { fill: #fff; stroke: #000; stroke-width: .5px; }
  .call-line { stroke: #fff; stroke-width: 1px; }
  .call-text { fill: #fff; font: 10px Arial, sans-serif; pointer-events: none; }
</style>

<div id="globeContainer"></div>

<script>
(function(){
  console.log("ðŸ”¥ Globe script startingâ€¦");

  const locations = [
    { label:"USAF HQ (NY)", lat:40.7128, lon:-74.0060, timeZone:"America/New_York" },
    { label:"London",       lat:51.5074, lon: -0.1278, timeZone:"Europe/London" },
    { label:"Tokyo",        lat:35.6895, lon:139.6917, timeZone:"Asia/Tokyo" }
    // â€¦add your sites hereâ€¦
  ];

  const w=400, h=400, spinMs=120000;
  const proj = d3.geoOrthographic()
                 .scale(180)
                 .translate([w/2,h/2])
                 .clipAngle(90);
  const path = d3.geoPath().projection(proj);

  const svg = d3.select("#globeContainer")
                .append("svg").attr("width",w).attr("height",h);

  svg.append("path")
     .datum({type:"Sphere"})
     .attr("class","sphere")
     .attr("d",path);

  d3.json("https://unpkg.com/world-atlas@2.0.2/world/110m.json")
    .then(world => {
      console.log("ðŸŒ Land data loaded");
      svg.append("path")
         .datum(topojson.feature(world, world.objects.land))
         .attr("class","land")
         .attr("d",path);

      svg.append("g").attr("id","markers");
      svg.append("g").attr("id","callouts");

      d3.timer(function(elapsed){
        const Î» = ( (elapsed % spinMs)/spinMs )*360 - 90;
        proj.rotate([Î»,0,0]);
        svg.selectAll("path").attr("d", path);
        drawPoints();
      });
    })
    .catch(e=> console.error("âŒ Could not load map:", e));

  function drawPoints(){
    const now = new Date();
    // circles
    const dots = svg.select("#markers").selectAll("circle")
      .data(locations);
    dots.join("circle")
        .attr("class","marker")
        .attr("r",3)
        .attr("cx",d=>proj([d.lon,d.lat])[0])
        .attr("cy",d=>proj([d.lon,d.lat])[1]);

    // callouts
    const calls = svg.select("#callouts").selectAll("g.callout")
      .data(locations);
    const enter = calls.enter().append("g").attr("class","callout");
    enter.append("line").attr("class","call-line");
    enter.append("text").attr("class","call-text");

    calls.merge(enter).each(function(d){
      const [x,y] = proj([d.lon,d.lat]);
      const dx=12, dy=-8;
      d3.select(this).select("line")
        .attr("x1",x).attr("y1",y)
        .attr("x2",x+dx).attr("y2",y+dy);
      d3.select(this).select("text")
        .attr("x",x+dx+2).attr("y",y+dy-2)
        .text(formatTime(d.timeZone, now));
    });
  }

  function formatTime(zone, dt){
    try {
      return dt.toLocaleTimeString('en-GB',{
        hour:'2-digit', minute:'2-digit',
        hour12:false, timeZone:zone
      });
    } catch {
      return "--:--";
    }
  }
})();
</script>